(function () {
  "use strict";

  new Vue({
    el: "#app",
    data: {
      // 把這裡換成你的 GAS；若不想改 GAS，請確保它支援回傳全名單（見下方 all=1）
      gas: "https://script.google.com/macros/s/AKfycbwyY7oLpoZ4lbcIwIWniLZ8U_pY8e7YBK9fakeszgR_77S2u1SV/exec",
      name: "",
      persons: {},     // 快取單筆（key = 姓名）
      allList: null,   // 一次性抓回的全名單（陣列）
      person: {},
      formAction: "https://docs.google.com/forms/u/0/d/e/1FAIpQLSeNBnd-yVJ7_-tMq5xaQrvt0j18UtabCFBTM0Eu2O3ivDecuQ/formResponse",
      input: {
        id: "entry.1815052017",
        name: "entry.1543576845",
        gender: "entry.892230025",
        phone: "entry.1003128242",
        site: "entry.260985931",
        msg: "entry.1782841550"
      },
      loading: false
    },

    methods: {
      // 從全名單依姓名找人（完全相符；需要模糊就把 === 換成包含或正規）
      pickByName: function(list, key) {
        if (!Array.isArray(list)) return null;
        return list.find(function(item){
          return (item && typeof item.name === "string" && item.name.trim() === key);
        }) || null;
      },

      ensureAllList: function() {
        var self = this;
        if (self.allList !== null) return Promise.resolve(self.allList);

        self.loading = true;
        // 建議你的 GAS 支援 all=1（或 list=1），回傳 [{id,name,gender,phone,site,message}, ...]
        var url = self.gas + "?all=1";
        return fetch(url, { method: "GET" })
          .then(function(r){ return r.json(); })
          .then(function(arr){
            self.allList = Array.isArray(arr) ? arr : [];
            self.loading = false;
            return self.allList;
          })
          .catch(function(){
            self.loading = false;
            self.allList = [];
            return self.allList;
          });
      },

      submit: function () {
        var self = this;
        if (this.person && this.person.name !== undefined) {
          var q =
            this.input.id + "=" + encodeURIComponent(this.person.id || "") + "&" +
            this.input.name + "=" + encodeURIComponent(this.person.name || "") + "&" +
            this.input.gender + "=" + encodeURIComponent(this.person.gender || "") + "&" +
            this.input.phone + "=" + encodeURIComponent(this.person.phone || "") + "&" +
            this.input.site + "=" + encodeURIComponent(this.person.site || "") + "&" +
            this.input.msg + "=" + encodeURIComponent(this.person.message || "無");

          // 用 GET 送 formResponse 比較直覺；原範例用 POST 也行
          fetch(this.formAction + "?" + q, { method: "GET" })
            .catch(function () {
              alert("提交成功。");
              self.name = "";
              self.person = {};
            });
        }
      }
    },

    watch: {
      // 監聽姓名輸入
      name: function (val) {
        var self = this;
        var key = (val || "").trim();
        if (key.length === 0) {
          self.person = {};
          return;
        }

        // 1) 先看快取
        if (typeof self.persons[key] !== "undefined") {
          self.person = self.persons[key];
          return;
        }

        // 2) 嘗試直擊 API：若你的 GAS 其實有支援 ?name=
        self.loading = true;
        var urlByName = self.gas + "?name=" + encodeURIComponent(key);
        fetch(urlByName, { method: "GET" })
          .then(function(r){ return r.json(); })
          .then(function(data){
            // 判斷是否帶有 id/name 等欄位，才能視為有效回應
            if (data && (data.id || data.name)) {
              self.persons[key] = data;
              self.person = data;
              self.loading = false;
              return;
            }
            // 3) 如果沒有有效資料，再退回到「抓全名單 → 本機比對」
            return self.ensureAllList().then(function(list){
              var found = self.pickByName(list, key) || {};
              self.persons[key] = found;
              self.person = found;
              self.loading = false;
            });
          })
          .catch(function(){
            // 直擊失敗 → 抓全名單 fallback
            self.ensureAllList().then(function(list){
              var found = self.pickByName(list, key) || {};
              self.persons[key] = found;
              self.person = found;
              self.loading = false;
            });
          });
      }
    }
  });
})();

