(function () {
  "use strict";

  new Vue({
    el: "#app",
    data: {
      // TODO: 改成你自己的 Apps Script（支援用 name 查單筆，或回傳全名單時也可以在前端比對）
      gas: "https://script.google.com/macros/s/AKfycbwyY7oLpoZ4lbcIwIWniLZ8U_pY8e7YBK9fakeszgR_77S2u1SV/exec",
      // 原本是 id；現在改成由姓名觸發查詢
      name: "",
      // 快取查過的姓名結果（key：姓名）
      persons: {},
      // 畫面上顯示的該位人員資料
      person: {},
      // Google 表單的 formResponse
      formAction:
        "https://docs.google.com/forms/u/0/d/e/1FAIpQLSeNBnd-yVJ7_-tMq5xaQrvt0j18UtabCFBTM0Eu2O3ivDecuQ/formResponse",
      // 對應欄位 Entry ID（維持原樣）
      input: {
        id: "entry.1815052017",
        name: "entry.1543576845",
        gender: "entry.892230025",
        phone: "entry.1003128242",
        site: "entry.260985931",
        msg: "entry.1782841550"
      },
      loading: false
    },

    methods: {
      submit: function () {
        var self = this;
        if (this.person && this.person.name !== undefined) {
          var q =
            this.input.id + "=" + encodeURIComponent(this.person.id) + "&" +
            this.input.name + "=" + encodeURIComponent(this.person.name) + "&" +
            this.input.gender + "=" + encodeURIComponent(this.person.gender || "") + "&" +
            this.input.phone + "=" + encodeURIComponent(this.person.phone || "") + "&" +
            this.input.site + "=" + encodeURIComponent(this.person.site || "") + "&" +
            this.input.msg + "=" + encodeURIComponent(this.person.message || "無");

          fetch(this.formAction + "?" + q, { method: "POST" })
            .catch(function () {
              alert("提交成功。");
              self.name = "";
              self.person = {};
            });
        }
      }
    },

    watch: {
      // 由姓名帶入資料：當姓名有值時就查一次（可視需要加上最小字數或 debounce）
      name: function (val) {
        var self = this;
        var key = (val || "").trim();
        if (key.length === 0) {
          self.person = {};
          return;
        }

        // 若快取裡已有，就直接帶入
        if (typeof self.persons[key] !== "undefined") {
          self.person = self.persons[key];
          return;
        }

        // 否則打 GAS，用 name 查詢
        self.loading = true;
        var url = self.gas + "?name=" + encodeURIComponent(key);
        fetch(url, { method: "POST" })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            // 預期回傳單一物件，如 { id, name, gender, phone, site, message }
            self.persons[key] = data;
            self.person = data;
            self.loading = false;
          })
          .catch(function () {
            self.loading = false;
            self.person = {};
          });
      }
    }
  });
})();
