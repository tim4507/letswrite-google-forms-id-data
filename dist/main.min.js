!function () {
  "use strict";
  new Vue({
    el: "#app",
    data: {
      gas: "https://script.google.com/macros/s/AKfycbzwLF32ipQfU2qf1r0L61ZxhQJ98OsDWebeGFe3pNoCWqAYIpU86deDwZUS2_ESuNzyyg/exec",
      name: "",
      id: "",
      persons: {},
      matches: [],
      msg: "",
      loading: false
    },
    methods: {
      _norm(s){ return String(s||"").trim().toLowerCase(); },

      lookupByName(){
        const q = this._norm(this.name);
        this.id = "";
        this.msg = "";
        this.matches = [];

        if(!q) return;

        const hits = Object.entries(this.persons)
          .filter(([id, p]) => this._norm(p && p.name) === q)
          .map(([id,p]) => ({id,name:p.name}));

        if(hits.length===0){
          this.msg = "查無此姓名";
        }else if(hits.length===1){
          this.id = hits[0].id;
        }else{
          this.matches = hits;
          this.msg = "同名 "+hits.length+" 筆，請點選其一";
        }
      },

      pick(id){
        this.id = id;
        this.matches = [];
        this.msg = "";
      },

      fetchAll(){
        this.loading = true;
        fetch(this.gas)
          .then(r=>r.json())
          .then(data=>{ this.persons=data||{}; })
          .catch(()=>{ this.msg="名單載入失敗"; })
          .finally(()=>{ this.loading=false; })
      }
    },
    mounted(){ this.fetchAll(); }
  });
}();

