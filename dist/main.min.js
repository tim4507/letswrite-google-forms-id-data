new Vue({
  el: "#app",
  data: {
    gas: "https://script.google.com/macros/s/AKfycbzFLzWTiJHC-8dJ7XAjiRRVavzZvVx3aZpCEYD9vI7-Tkk_XJIvJP-F7S6GpDFBKDgzUg/exec",
    id: "",
    name: "",
    persons: {},
    person: {},
    formAction: "https://docs.google.com/forms/u/0/d/1EXAfBMjg8nPqyr4Ua6dYhy05zm5Uf2RWA7VPqVpVNBk/previewResponse",
    input: {
      id:   "entry.1381152897",     // 表單的「ID」欄位 entry id
      name: "entry.470868206"      // 表單的「姓名」欄位 entry id
    },
    loading: false
  },
  methods: {
    submit () {
      if (this.person.name === undefined) return
      const q =
        `${this.input.id}=${encodeURIComponent(this.person.id)}&` +
        `${this.input.name}=${encodeURIComponent(this.person.name)}`

      fetch(this.formAction + "?" + q, { method: "POST" })
        .catch(err => {
          alert("提交成功。")
          this.id = ""
          this.name = ""
          this.person = {}
        })
    }
  },
  watch: {
    name (val) {
      if (!val || val.trim().length === 0) return

      if (this.persons[this.name] === undefined) {
        this.loading = true
        const url = this.gas + "?name=" + encodeURIComponent(this.name.trim())
        fetch(url, { method: "POST" })
          .then(r => r.json())
          .then(ret => {
            this.persons[this.name] = ret
            this.person = ret
            this.id = ret && ret.id ? ret.id : ""
            this.loading = false
          })
      } else {
        this.person = this.persons[this.name]
        this.id = this.person && this.person.id ? this.person.id : ""
      }
    }
  }
})

